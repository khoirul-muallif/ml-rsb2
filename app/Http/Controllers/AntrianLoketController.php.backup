<?php

namespace App\Http\Controllers;

use App\Models\AntrianLoket;
use App\Models\MliteSetting;
use App\Helpers\AntrianHelper;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class AntrianLoketController extends Controller
{
    /**
     * Halaman anjungan pasien
     */
    public function index()
    {
        $logo = MliteSetting::getSetting('settings', 'logo', 'logo.png');
        $namaInstansi = MliteSetting::getSetting('settings', 'nama_instansi', 'Rumah Sakit');
        $alamat = MliteSetting::getSetting('settings', 'alamat', '');
        $runningText = MliteSetting::getSetting('anjungan', 'text_anjungan', 'Selamat datang');
        
        $loketTypes = AntrianHelper::getAllSorted();
        
        $today = now()->toDateString();
        $summary = $this->getSummary($today);
        
        return view('anjungan.loket.index', [
            'logo' => $logo,
            'nama_instansi' => $namaInstansi,
            'alamat' => $alamat,
            'running_text' => $runningText,
            'loket_types' => $loketTypes,
            'summary' => $summary
        ]);
    }

    /**
     * Helper: Get summary untuk tanggal tertentu
     * ✅ ONLY count TODAY's antrian
     */
    private function getSummary($date = null)
    {
        if (!$date) {
            $date = now()->toDateString();
        }

        $types = ['Loket', 'LoketVIP', 'CS', 'CSVIP', 'Apotek'];
        $summary = [];
        
        foreach ($types as $type) {
            $config = AntrianHelper::getByType($type);
            
            if (!$config) continue;
            
            // ✅ PENTING: Filter by postdate = today ONLY
            $total = DB::table('mlite_antrian_loket')
                ->where('type', $type)
                ->where('postdate', $date)  // ✅ Only today
                ->count();
            
            $menunggu = DB::table('mlite_antrian_loket')
                ->where('type', $type)
                ->where('postdate', $date)  // ✅ Only today
                ->where('status', '0')
                ->count();
            
            $lastNumber = DB::table('mlite_antrian_loket')
                ->where('type', $type)
                ->where('postdate', $date)  // ✅ Only today
                ->orderByDesc('noantrian')
                ->value('noantrian') ?? 0;
            
            $summary[$type] = [
                'label' => $config['label'],
                'prefix' => $config['prefix'],
                'total' => $total,
                'menunggu' => $menunggu,
                'last_number' => $lastNumber
            ];
        }
        
        return $summary;
    }

    /**
     * API: Ambil nomor antrian baru
     * ✅ HANYA ambil dari antrian hari ini
     */
    public function ambil(Request $request)
    {
        try {
            $request->validate([
                'type' => 'required|string|in:Loket,LoketVIP,CS,CSVIP,Apotek'
            ]);

            $type = $request->type;
            $today = now()->toDateString();

            $config = AntrianHelper::getByType($type);
            
            if (!$config) {
                return response()->json([
                    'status' => false,
                    'message' => 'Tipe loket tidak valid'
                ], 400);
            }

            // ✅ PENTING: Hanya ambil last number dari hari INI
            $lastNumber = DB::table('mlite_antrian_loket')
                ->where('type', $type)
                ->where('postdate', $today)  // ✅ Only today!
                ->orderByDesc('noantrian')
                ->value('noantrian');

            // Jika tidak ada antrian hari ini, mulai dari 1
            $nextNumber = $lastNumber ? (int)$lastNumber + 1 : 1;

            // Insert antrian baru
            $id = DB::table('mlite_antrian_loket')->insertGetId([
                'type' => $type,
                'noantrian' => $nextNumber,
                'postdate' => $today,  // ✅ Set postdate hari ini
                'status' => '0',
                'category' => $config['category'] ?? 'reguler',
                'loket' => '0',
                'start_time' => now()->format('H:i:s'),
                'end_time' => '00:00:00',
                'no_rkm_medis' => null
            ]);

            $displayNumber = $config['prefix'] . $nextNumber;

            return response()->json([
                'status' => true,
                'id' => $id,
                'type' => $type,
                'prefix' => $config['prefix'],
                'nomor' => $nextNumber,
                'display' => $displayNumber,
                'label' => $config['full_label'],
                'color' => $config['color'],
                'category' => $config['category'] ?? 'reguler',
                'timestamp' => now()->format('Y-m-d H:i:s')
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'status' => false,
                'message' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * API: Get summary antrian hari ini
     * ✅ HANYA dari antrian hari ini
     */
    public function summary()
    {
        try {
            $today = now()->toDateString();
            $summary = $this->getSummary($today);
            
            return response()->json([
                'status' => true,
                'date' => $today,
                'summary' => $summary
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'status' => false,
                'message' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * API: Get info antrian by ID
     */
    public function info($id)
    {
        try {
            $antrian = DB::table('mlite_antrian_loket')
                ->where('kd', $id)
                ->first();

            if (!$antrian) {
                return response()->json([
                    'status' => false,
                    'message' => 'Antrian tidak ditemukan'
                ], 404);
            }

            $config = AntrianHelper::getByType($antrian->type);
            $displayNumber = $config['prefix'] . $antrian->noantrian;

            return response()->json([
                'status' => true,
                'id' => $antrian->kd,
                'type' => $antrian->type,
                'prefix' => $config['prefix'],
                'nomor' => $antrian->noantrian,
                'display' => $displayNumber,
                'label' => $config['full_label'],
                'status_antrian' => $antrian->status,
                'loket' => $antrian->loket,
                'timestamp' => $antrian->postdate . ' ' . $antrian->start_time
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'status' => false,
                'message' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * API: Cek nomor antrian
     * ✅ HANYA cek dari antrian hari ini
     */
    public function cek(Request $request)
    {
        try {
            $request->validate([
                'display' => 'required|string'
            ]);

            $display = strtoupper($request->display);
            $today = now()->toDateString();
            
            // Parse prefix dan nomor
            preg_match('/^([A-Z]+)(\d+)$/', $display, $matches);
            
            if (count($matches) !== 3) {
                return response()->json([
                    'status' => false,
                    'message' => 'Format nomor tidak valid'
                ], 400);
            }
            
            $prefix = $matches[1];
            $nomor = (int)$matches[2];
            
            $config = AntrianHelper::getByPrefix($prefix);
            
            if (!$config) {
                return response()->json([
                    'status' => false,
                    'message' => 'Prefix tidak dikenali'
                ], 400);
            }
            
            // ✅ PENTING: Cek hanya dari hari ini
            $antrian = DB::table('mlite_antrian_loket')
                ->where('type', $config['type'])
                ->where('noantrian', $nomor)
                ->where('postdate', $today)  // ✅ Only today!
                ->first();
            
            if (!$antrian) {
                return response()->json([
                    'status' => false,
                    'message' => 'Nomor antrian tidak ditemukan'
                ], 404);
            }
            
            // Hitung posisi
            $posisi = DB::table('mlite_antrian_loket')
                ->where('type', $config['type'])
                ->where('postdate', $today)  // ✅ Only today!
                ->where('noantrian', '<', $nomor)
                ->where('status', '0')
                ->count() + 1;
            
            return response()->json([
                'status' => true,
                'nomor' => $display,
                'label' => $config['full_label'],
                'status_antrian' => $antrian->status,
                'status_label' => $this->getStatusLabel($antrian->status),
                'posisi' => $posisi,
                'loket' => $antrian->loket > 0 ? $antrian->loket : null
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'status' => false,
                'message' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Helper: Get status label
     */
    private function getStatusLabel($status)
    {
        return match($status) {
            '0' => 'Menunggu',
            '1' => 'Sedang Dipanggil',
            '2' => 'Selesai',
            '3' => 'Tidak Hadir',
            default => 'Unknown'
        };
    }
}