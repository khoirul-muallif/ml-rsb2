<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class AntrianLoket extends Model
{
    public $timestamps = false;
    protected $table = 'mlite_antrian_loket';
    protected $primaryKey = 'kd';

    protected $fillable = [
        'type',
        'noantrian',
        'no_rkm_medis',
        'postdate',
        'start_time',
        'end_time',
        'status',
        'loket'
    ];

    protected $casts = [
        'postdate' => 'date',
        'start_time' => 'datetime:H:i:s',
        'end_time' => 'datetime:H:i:s',
    ];

    // ========================================
    // SCOPES
    // ========================================
    
    public function scopeHariIni($query)
    {
        return $query->whereDate('postdate', today());
    }

    public function scopeByType($query, $type)
    {
        return $query->where('type', $type);
    }


    public function scopeByStatus($query, $status)
    {
        return $query->where('status', $status);
    }

    public function scopeBelumDipanggil($query)
    {
        return $query->where('status', '0');
    }

    public function scopeDipanggil($query)
    {
        return $query->where('status', '1');
    }

    public function scopeSelesai($query)
    {
        return $query->where('status', '2');
    }

    // ========================================
    // STATIC METHODS
    // ========================================

    public static function getNomorTerakhir($type, $tanggal = null)
    {
        $tanggal = $tanggal ?? today();
        
        $antrian = self::where('type', $type)
            ->whereDate('postdate', $tanggal)
            ->orderByDesc('noantrian')
            ->first();

        return $antrian ? (int)$antrian->noantrian : 0;
    }

    public static function getJumlahAntrian($type, $tanggal = null)
    {
        $tanggal = $tanggal ?? today();
        
        return self::where('type', $type)
            ->whereDate('postdate', $tanggal)
            ->count();
    }

    public static function getPrefixHuruf($type)
    {
        $prefix = [
        'Loket' => 'A',
        'LoketVIP' => 'AV',  // ← Tambahkan
        'CS' => 'B',
        'CSVIP' => 'BV',     // ← Tambahkan
        'Apotek' => 'F',
        'IGD' => 'C'
    ];

    return $prefix[$type] ?? 'X';
    }

    /**
     * Get antrian terbaru yang sedang dipanggil (status = 1)
     * Digunakan untuk display/monitor TV
     */
    public static function getTerbaruDipanggil($type = null)
    {
        $query = self::where('status', '1')
            ->whereDate('postdate', today())
            ->orderByDesc('end_time')
            ->orderByDesc('kd');

        if ($type) {
            $query->where('type', $type);
        }

        return $query->first();
    }

    /**
     * Get antrian berikutnya yang belum dipanggil
     * Digunakan untuk operasi pemanggil
     */
    public static function getBerikutnya($type, $tanggal = null)
    {
        $tanggal = $tanggal ?? today();

        return self::where('type', $type)
            ->whereDate('postdate', $tanggal)
            ->where('status', '0')
            ->orderBy('noantrian')
            ->first();
    }

    /**
     * Get summary statistik antrian
     */
    public static function getSummary($tanggal = null)
    {
        $tanggal = $tanggal ?? today();

        return [
            'loket' => [
                'total' => self::where('type', 'Loket')->whereDate('postdate', $tanggal)->count(),
                'selesai' => self::where('type', 'Loket')->where('status', '2')->whereDate('postdate', $tanggal)->count(),
                'diproses' => self::where('type', 'Loket')->where('status', '1')->whereDate('postdate', $tanggal)->count(),
                'menunggu' => self::where('type', 'Loket')->where('status', '0')->whereDate('postdate', $tanggal)->count(),
            ],
            'cs' => [
                'total' => self::where('type', 'CS')->whereDate('postdate', $tanggal)->count(),
                'selesai' => self::where('type', 'CS')->where('status', '2')->whereDate('postdate', $tanggal)->count(),
                'diproses' => self::where('type', 'CS')->where('status', '1')->whereDate('postdate', $tanggal)->count(),
                'menunggu' => self::where('type', 'CS')->where('status', '0')->whereDate('postdate', $tanggal)->count(),
            ],
            'apotek' => [
                'total' => self::where('type', 'Apotek')->whereDate('postdate', $tanggal)->count(),
                'selesai' => self::where('type', 'Apotek')->where('status', '2')->whereDate('postdate', $tanggal)->count(),
                'diproses' => self::where('type', 'Apotek')->where('status', '1')->whereDate('postdate', $tanggal)->count(),
                'menunggu' => self::where('type', 'Apotek')->where('status', '0')->whereDate('postdate', $tanggal)->count(),
            ]
        ];
    }

    // ========================================
    // ATTRIBUTES (Accessors)
    // ========================================

    public function getNomorAntrianLengkapAttribute()
    {
        $prefix = self::getPrefixHuruf($this->type);
        return $prefix . $this->noantrian;
    }

    /**
     * Status label untuk display
     */
    public function getStatusLabelAttribute()
    {
        $status = [
            '0' => 'Menunggu',
            '1' => 'Dipanggil',
            '2' => 'Selesai',
            '3' => 'Tidak Hadir'
        ];

        return $status[$this->status] ?? 'Unknown';
    }

    // Relasi ke pasien (optional, sesuaikan dengan struktur database kamu)
    // public function pasien()
    // {
    //     return $this->belongsTo(Pasien::class, 'no_rkm_medis', 'no_rkm_medis');
    // }
}